<%= content_for :head do %>
  <style>
    section.overlay.cover.fullscreen {
      min-height:1500px!important;
    }

    p.group-tag {
      margin-bottom:0;
    }

    .group-elem {
      margin-bottom: 5px!important;
    }

    form input {
      height: 35px!important;
    }

    form input[type="submit"] {
      height: inherit!important;
    }

  </style>

  <%= stylesheet_link_tag 'bootstrap-datepicker/bootstrap-datepicker3.css', 'data-turbolinks-track' => true %>
<% end %>

<section class="cover fullscreen image-bg overlay">
  <div class="background-image-holder">
    <%= image_tag "home2.jpg", class:"background-image", alt:"image" %>
  </div>
  <div class="container v-align-transform">
    <div class="row">
      <section>
        <div class="col-sm-6 col-sm-offset-3">
          <div class="feature bordered text-center">
            <h4 class="uppercase">Register Here</h4>
            <%= form_for(resource, html: { class: 'text-left' }, as: resource_name, url: registration_path(resource_name)) do |f| %>
              <%= fields_for :ambassador do |ff| %>
                <%= devise_error_messages! %>
                <%= flash[:error] %>

                <p class="group-tag">Identity</p>
                <div class="row">
                  <div class="col-sm-7">
                    <%= f.email_field :email, placeholder: "Email Address", autofocus: true, class:"group-elem", value: @ambassador.email, required: true %>
                  </div>
                  <div class="col-sm-5">
                    <%= ff.telephone_field :phone, placeholder: "Phone Number", class:"group-elem" %>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-6">
                    <%= ff.text_field :fname, placeholder: "First Name", class:"group-elem" %>
                  </div>
                  <div class="col-sm-6">
                    <%= ff.text_field :lname, placeholder: "Last Name", class:"group-elem" %>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-5">
                    <%= ff.text_field :dob, placeholder: 'Date of Birth', data: { provide: 'datepicker', 'date-format': 'yyyy-mm-dd', 'date-end-date': "+0d", 'date-start-view': 2 } %>
                  </div>
                  <div class="col-sm-7">
                    <%= text_field_tag :ssn_last_4, '', placeholder: "Last 4 Of SSN", class:"group-elem" %>
                    <p class="help-block">This is used to verify your bank account information and is not stored on our server</p>
                  </div>
                </div>

                <p class="group-tag">Address</p>
                <div class="row">
                  <div class="col-sm-7">
                    <%= ff.text_field :street, placeholder: "Street", class:"group-elem" %>
                  </div>
                  <div class="col-sm-5">
                    <%= ff.text_field :city, placeholder: "City", class:"group-elem" %>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm-9">
                    <%# TODO: Make this a select tag %>
                    <%= ff.text_field :state, placeholder: "State", class:"group-elem" %>
                  </div>
                  <div class="col-sm-3">
                    <%= ff.text_field :zip, placeholder: "Zip Code" %>
                  </div>
                </div>

                <p class="group-tag">Security</p>
                <%= f.password_field :password, placeholder: "Password (#{@minimum_password_length} characters minimum)", class:"group-elem", autocomplete: "off" %>
                <%= f.password_field :password_confirmation, placeholder: "Confirm Password", autocomplete: "off" %>

                <p class="group-tag">Referred By A Member?</p>
                <%= text_field_tag :referrer_token, @ambassador.parent.try(:token), placeholder: "Enter Their Referral Token", readonly: !@ambassador.parent.nil? %>

                <%= hidden_field_tag 'registration_token', params[:registration_token] %>
                <%= hidden_field_tag 'id', params[:id] %>

                <%= hidden_field_tag 'token' %>
                <%= hidden_field_tag 'plan_id' %>

                <%#= f.submit "Register" %>
                <input type="submit" id="register-btn" value="Register"/>

                <hr />
                <%= render "accounts/shared/links" %>
              <% end %>
            <% end %>

            <p class="mb0">By signing up, you agree to our
              <a href="#">Terms Of Use</a>
            </p>
          </div>
        </div>
      </section>
    </div>
  </div>
</section>

<%= content_for :js_includes do  %>
  <%= javascript_include_tag 'bootstrap-datepicker/bootstrap-datepicker.js', 'data-turbolinks-track' => true %>
  <script src="https://checkout.stripe.com/checkout.js"></script>
  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>

  <script type="text/javascript">

  $(document).ready(function(){
    form = $('form#new_account');
    plan = {id: 'subscription', name: '1 Year of Standard ODH Services', amount: 350000}; // TODO: add ability to select a plan

    function validateForm(form) {
      // Ensure presence of all fields
      if (form)
    };

    var handler = StripeCheckout.configure({
      key: "<%= Rails.application.secrets.stripe_publishable_key %>",
      allowRememberMe: false,
      token: function(token) {
        submitting = true
        form.find('input[name=token]').val( token.id )
        form.find('input[name=plan_id]').val( plan.id )
        form.get(0).submit()
        // Use the token to create the charge with a server-side script.
        // You can access the token ID with `token.id`
      }
    });

    $('#register-btn').on('click', function(e) {
      e.preventDefault();
      // Easy Validate the Form Before Opening Handler
      if (validateForm(form)) {

        // Open Checkout with further options
        handler.open({
          name: 'ODH Yearly Subscription',
          description: plan.name,
          amount: plan.amount,
          email: $('input[type=email]').val(),
        });
      } else {
        // print errors
        alert('error')
      }

    });

    // Close Checkout on page navigation
    $(window).on('popstate', function() {
      handler.close();
    });
  });
  </script>
<% end %>
